<!doctype html> 

<html lang="en"> 
  <head> 
    <meta charset="UTF-8" />
    <title>YOU ARE THE MONSTER - Ludum Dare 33 - WIP</title>
    <script type="text/javascript" src="../lib/phaser.min.js"></script>
    <style type="text/css">
body {
  margin: 0;
}
canvas {
  margin: 0
}

    </style>
  </head>
  <body>

    <script type="text/javascript">

var game = new Phaser.Game(640, 400, Phaser.AUTO, '', { preload: preload, create: create, update: update });



function preload() 
{
  this.scale.scaleMode = Phaser.ScaleManager.NO_SCALE;
  this.scale.pageAlignHorizontally = true;
  this.scale.pageAlignVertically = true;
  game.world.setBounds(0,0,5000,2000);

  this.game.physics.startSystem(Phaser.Physics.ARCADE);

  game.load.atlasJSONHash(
      'ytm-atlas',
      '../assets/ytm-atlas.png',
      '../assets/ytm-atlas.json'
      );
  this.load.tilemap('level1', '../levels/level1.json', null, Phaser.Tilemap.TILED_JSON);
  this.load.image('ytm-tiles', '../assets/ytm-tiles.png');
  this.load.audio('splash2', '../assets/splash2.mp3');
}

objects = function(type, map, layer) {
  var result = new Array();
  map.objects[layer].forEach(function(element){
    //console.log("Type sought", type, "Type found", element.type, element.type);
    if(element.type === type) {
      //element.y -= map.tileHeight;
      result.push(element);
    }      
  });
  return result;
};

var tankers;

function create() 
{
  game.physics.startSystem(Phaser.Physics.ARCADE);
  game.camera.roundPx = false;
  this.game.stage.backgroundColor = '#0000CC';

  this.splash = this.add.audio('splash2');
  this.map = this.game.add.tilemap('level1');
  this.map.addTilesetImage('ytm-tiles', 'ytm-tiles');


  //create layer
  this.backgroundlayer = this.map.createLayer('backgroundLayer');
  this.blockedLayer = this.map.createLayer('blockedLayer');

  this.map.setCollisionBetween(1, 100000, true, this.blockedLayer);
  tankers = this.add.group();
  tankers.enableBody = true;

  objects('Tanker', this.map, 'objectsLayer').forEach(function(tanker) {
    var _t = tankers.create(tanker.x, tanker.y - (170/2), 'ytm-atlas', 'tanker.png');
    _t.body.immovable = true;
    _t.body.setSize(_t.body.width, 78, 0 , 91);
  });

  //create player
  var playerStart = objects('playerStart', this.map, 'objectsLayer')

  this.player = this.game.add.sprite(playerStart[0].x, playerStart[0].y, 'ytm-atlas', 'iceman-front.png');

  this.player_colliding = false;
  this.player.anchor.setTo(0.5);
  this.player.animations.add('left', ['iceman-side.png', 'iceman-front.png'], 10, true);
  this.game.physics.arcade.enable(this.player);

  //the camera will follow the player in the world
  this.game.camera.follow(this.player);

  //move player with cursor keys
  this.cursors = this.game.input.keyboard.createCursorKeys();
}

tanker_collision_callback = function(arg1, arg2, arg3)
{
  //console.log(arg1, arg2, arg3);
  console.log(arg1.body.height, arg1.body.width);
  //console.log(arg1._bounds.bottomLeft.x, arg1._bounds.bottomRight.x);
  if (!this.player_colliding)
    this.splash.play();
}

function update() 
{
  //player movement
  this.player.body.velocity.y = 0;
  this.player.body.velocity.x = 0;

  if(this.cursors.up.isDown) {
    this.player.body.velocity.y -= 250;
  }
  else if(this.cursors.down.isDown) {
    this.player.body.velocity.y += 250;
  }
  if(this.cursors.left.isDown) {
    this.player.body.velocity.x -= 250;
    //this.player.animations.play('left');
  }
  else if(this.cursors.right.isDown) {
    this.player.body.velocity.x += 250;
  } else
    this.player.animations.stop();

  this.game.physics.arcade.collide(this.player, this.blockedLayer);
  if (this.game.physics.arcade.overlap(this.player, tankers, tanker_collision_callback, null, this))
    this.player_colliding = true;
  else
    this.player_colliding = false;
}
    </script>

  </body>

</html>
