<!doctype html> 

<html lang="en"> 
  <head> 
    <meta charset="UTF-8" />
    <title>YOU ARE THE MONSTER - Ludum Dare 33 - WIP</title>
    <script type="text/javascript" src="../lib/phaser.min.js"></script>
    <script type="text/javascript" src="../lib/Shake.js"></script>
    <style type="text/css">
body {
  margin: 0;
}
canvas {
  margin: 0
}

    </style>
  </head>
  <body>

    <script type="text/javascript">

var intro_track;

Game = {};

Game.Intro = function(){};
Game.Menu = function(){};
Game.Play = function(){};
Game.Intro.prototype = 
{
  preload: function()
  {
    this.loading_text = this.game.add.text(game.world.centerX, game.world.centerY, "loading...",  {fill: "#ffffff"});
    this.loading_text.anchor.setTo(0.5);
    this.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
    this.scale.pageAligNHorizontally = true;
    this.scale.pageAlignVertically = true;
    this.load.image('icebergman', '../assets/icebergman-smaller.jpg');
    this.load.script('pixelate', 'https://cdn.rawgit.com/photonstorm/phaser/master/filters/Pixelate.js');
    this.load.audio('intro', '../assets/intro.mp3');
  },

  create: function() 
  {
    this.game.stage.backgroundColor = '#000000';
    var pixelate = game.add.filter('Pixelate');
    this.loading_text.destroy(true);
    var icebergman = this.game.add.sprite(0, 0, 'icebergman');
    icebergman.filters = [pixelate];
    pixelate.sizeX = 100;
    pixelate.sizeY = 100;
    var tween = game.add.tween(pixelate).to( { sizeX: 1, sizeY: 1 }, 5000, "Quad.easeInOut", true)
    tween.onComplete.add(function(){
      var text = this.game.add.text(game.world.centerX, 150, "You are Is-O...\nYour kin have been melted by global warming\nYou vow to exact revenge on the oil tankers\nplaguing your home waters\n",  {fill: "#ffffff", align:"center"});
      text.anchor.setTo(0.5);
      text.alpha = 0.1;
      var text_tween = game.add.tween(text).to({ alpha: 1}, 4000, "Linear", true );
      text_tween.onComplete.add(function() {
        var start_text = game.add.text(320,300, "Use arrow keys to control Is-O\nPress any key to begin", { fill: "#ffffff", align:"center"});
        start_text.anchor.setTo(0.5);
        
      });
    });

    intro_track = this.game.add.audio('intro');

    game.sound.setDecodedCallback(intro_track, function() { intro_track.loopFull(0.6)}, this);

  },

  update: function()
  {
    this.game.input.keyboard.onDownCallback = function(e)
    {
      this.game.input.keyboard.onDownCallback = undefined;
      intro_track.stop();
      this.game.state.start("Play", false, false);
      //console.log(e.keyCode);
    }
  }
}

var level = 1, playing = false, StandingInWaterFilter, player;

Game.Play.prototype = 
{
  preload: function()
  {
    this.loading_text = this.game.add.text(game.world.centerX, game.world.centerY, "loading...",  {fill: "#ffffff"}); this.loading_text.anchor.setTo(0.5);
    this.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
    this.scale.pageAlignHorizontally = true;
    this.scale.pageAlignVertically = true;
    game.stage.smoothed = false;

    this.game.physics.startSystem(Phaser.Physics.ARCADE);

    game.load.atlasJSONHash(
        'ytm-atlas',
        '../assets/ytm-atlas.png',
        '../assets/ytm-atlas.json'
        );
    this.load.tilemap('level' + level, '../levels/level' + level + '.json', null, Phaser.Tilemap.TILED_JSON);
    this.load.image('ytm-tiles', '../assets/ytm-tiles.png');
    this.load.audio('splash2', '../assets/splash2.mp3');
    this.load.audio('pcp', '../assets/pcp.mp3');
    this.load.script('StandingInWater', '../src/standinginwater.js');
  },

  create: function() 
  {
    this.loading_text.destroy(true);
    game.physics.startSystem(Phaser.Physics.ARCADE);
    game.camera.roundPx = false;
    this.game.stage.backgroundColor = '#000000';
    shake = new Phaser.Plugin.Shake(game);
    game.plugins.add(shake);

    this.splash = this.add.audio('splash2');
    this.map = this.game.add.tilemap('level' + level);
    this.map.addTilesetImage('ytm-tiles', 'ytm-tiles');

    //create layer
    this.backgroundLayer = this.map.createLayer('backgroundLayer');
    console.log(this.backgroundLayer);
    //this.backgroundLayer.worldScale(0.25);
    this.blockedLayer = this.map.createLayer('blockedLayer');
    this.world.setBounds(0,0,this.map.widthInPixels, this.map.heightInPixels);
    console.log(this.blockedLayer);

    //this.map.setCollisionBetween(1, 100000, true, this.blockedLayer);

    tankers = this.add.group();
    tankers.enableBody = true;

    objects('Tanker', this.map, 'objectsLayer').forEach(function(tanker) {
      var _t = tankers.create(tanker.x + 210, tanker.y - (170/2), 'ytm-atlas', 'tanker.png');
      _t.body.immovable = true;
      _t.body.setSize(_t.body.width, 60, 5 , 60);
      _t.anchor.setTo(0.5);
      numberOfTankers++;
    });

    text = game.add.text(10, 10, "Tankers: " + numberOfTankers, { font: "30px TheFont"} );
    text.fixedToCamera = true;

    //create player
    var playerStart = objects('playerStart', this.map, 'objectsLayer')

    player = this.game.add.sprite(playerStart[0].x, playerStart[0].y, 'ytm-atlas', 'iceman-front.png');

    player.anchor.setTo(0.5);
    player.animations.add('left', ['iceman-side.png', 'iceman-front.png'], 10, true);
    this.game.physics.arcade.enable(player);

    player.body.collideWorldBounds = true;

    //the camera will follow the player in the world
    this.game.camera.follow(player);

    StandingInWaterFilter = game.add.filter('StandingInWater');

    console.log(StandingInWaterFilter);
    console.log(Phaser.Filter.StandingInWater);

    player.filters = [StandingInWaterFilter];

    //move player with cursor keys
    this.cursors = this.game.input.keyboard.createCursorKeys();

    pcp = game.add.audio('pcp');

    function start() {
      if (!playing)
        pcp.loopFull(0.6);
        playing = true;
    }

    game.sound.setDecodedCallback(pcp, start, this);
  },

  update: function()
  {
    //player movement
    player.body.velocity.y = 0;
    player.body.velocity.x = 0;

    if(this.cursors.up.isDown) {
      player.body.velocity.y -= 250;
    }
    else if(this.cursors.down.isDown) {
      player.body.velocity.y += 250;
    }
    if(this.cursors.left.isDown) {
      player.body.velocity.x -= 250;
      //player.animations.play('left');
    }
    else if(this.cursors.right.isDown) {
      player.body.velocity.x += 250;
    } else
      player.animations.stop();

    this.game.physics.arcade.collide(player, this.blockedLayer);

    this.game.physics.arcade.overlap(player, tankers, tanker_collision_callback, null, this);
    if (numberOfTankers == 0)
    {
      //level++;
      this.game.state.restart(false, false);
    }
    StandingInWaterFilter.uniforms.posY.value = -((player.position.y - game.camera.view.y));
  }
}


var game = new Phaser.Game(640, 400, Phaser.AUTO, '', Game.Intro);

game.state.add("Play", Game.Play);
game.state.add("Intro", Game.Intro);

tanker_collision_callback = function(body1, arg2)
{
  if (!arg2.destruction)
  {
    arg2.destruction = true;
    this.splash.play();
    var tween = game.add.tween(arg2).to({ angle: -5, y: arg2.body.y - 25}, 1000, "Quart.easeOut", true);
    shake.shake(20, arg2);

    tween.onComplete.add(function() {
      arg2.destroy(true);
      numberOfTankers--;
      text.text="Tankers: " + numberOfTankers;
    }
    );
  }
}

objects = function(type, map, layer) {
  var result = new Array();
  map.objects[layer].forEach(function(element){
    //console.log("Type sought", type, "Type found", element.type, element.type);
    if(element.type === type) {
      //element.y -= map.tileHeight;
      result.push(element);
    }      
  });
  return result;
};

var tankers;
var shake;

var text;

var numberOfTankers = 0;

    </script>

  </body>

</html>
